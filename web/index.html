<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Altindan Menu</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 12px; background:#fff; color:#111 }
    .card { border:1px solid #eee; padding:10px; margin-bottom:10px; border-radius:8px; display:flex; gap:12px; align-items:center }
    img { width:80px; height:80px; object-fit:cover; border-radius:6px }
    button { padding:8px 12px; border-radius:6px; border:none; background:#2b8cff; color:white; cursor:pointer }
  </style>
</head>
<body>
  <h2>Menu</h2>
  <div id="products">Loading...</div>

<script>
async function loadProducts(){
  const res = await fetch('/api/products');
  const data = await res.json();
  const container = document.getElementById('products');
  container.innerHTML = '';
  data.forEach(p=>{
    const title = (navigator.language && navigator.language.startsWith('ru')) ? p.title_ru : p.title_uz;
    const imgPath = p.img && p.img.startsWith('/') ? (location.origin + p.img) : p.img;
    const el = document.createElement('div');
    el.className = 'card';
    el.innerHTML = `<img src="${imgPath}" alt=""><div style="flex:1"><h3 style="margin:0">${title}</h3><div style="color:#666">${p.price}</div></div>
      <div><button onclick='buy("${p.id}")'>Buy</button></div>`;
    container.appendChild(el);
  });
}

let selectedProduct=null;
async function buy(productId){
  const resP = await fetch('/api/products');
  const products = await resP.json();
  selectedProduct = products.find(x=>x.id===productId);
  const address = prompt("Manzilni kiriting:");
  if(!address) return alert("Manzil kiritilmadi");
  const payload = {
    productId: selectedProduct.id,
    title_uz: selectedProduct.title_uz,
    title_ru: selectedProduct.title_ru,
    price: selectedProduct.price,
    img: selectedProduct.img && (selectedProduct.img.startsWith('/') ? location.origin + selectedProduct.img : selectedProduct.img),
    address,
    qty: 1,
    time: new Date().toISOString()
  };
  const resp = await fetch('/api/order', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(resp.ok){
    alert('Buyurtma yuborildi âœ…');
    // agar Telegram WebApp orqali ochilgan bo'lsa - yopish:
    try { if(window.Telegram && window.Telegram.WebApp) Telegram.WebApp.close(); } catch(e){}
  } else {
    const txt = await resp.text();
    alert('Xatolik: '+txt);
  }
}

loadProducts();
</script>
</body>
</html>
